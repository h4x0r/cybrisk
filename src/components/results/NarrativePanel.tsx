'use client';

import { useEffect, useRef, useState } from 'react';
import type { AssessmentInputs, SimulationResults } from '@/lib/types';
import type { Currency } from '@/lib/currency';

interface Props {
  inputs: AssessmentInputs;
  results: SimulationResults;
  currency: Currency;
  onNarrativeReady?: (text: string) => void;
}

type Status = 'loading' | 'streaming' | 'done' | 'error';

export function NarrativePanel({ inputs, results, currency, onNarrativeReady }: Props) {
  const [text, setText] = useState('');
  const [status, setStatus] = useState<Status>('loading');
  const prevCurrency = useRef<Currency>(currency);
  const abortRef = useRef<AbortController | null>(null);

  useEffect(() => {
    // Re-fetch when currency changes
    if (prevCurrency.current !== currency) {
      prevCurrency.current = currency;
    }

    const controller = new AbortController();
    abortRef.current = controller;
    setText('');
    setStatus('loading');

    let accumulated = '';

    (async () => {
      try {
        const res = await fetch('/api/narrative', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inputs, results, currency }),
          signal: controller.signal,
        });

        if (!res.ok || !res.body) {
          setStatus('error');
          return;
        }

        setStatus('streaming');
        const reader = res.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          accumulated += chunk;
          setText(accumulated);
        }

        setStatus('done');
        onNarrativeReady?.(accumulated);
      } catch (err) {
        if ((err as Error).name !== 'AbortError') {
          setStatus('error');
        }
      }
    })();

    return () => controller.abort();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [currency]); // re-run when currency changes

  return (
    <div
      className="rounded-lg p-4 mb-6"
      style={{
        background: 'rgba(255,255,255,0.03)',
        border: '1px solid rgba(255,255,255,0.08)',
        borderLeft: '2px solid #06b6d4',
      }}
    >
      {status === 'loading' && (
        <div className="space-y-2 animate-pulse">
          <div className="h-3 bg-white/10 rounded w-full" />
          <div className="h-3 bg-white/10 rounded w-5/6" />
          <div className="h-3 bg-white/10 rounded w-4/6" />
        </div>
      )}

      {(status === 'streaming' || status === 'done') && (
        <p className="text-sm leading-relaxed text-slate-200">{text}</p>
      )}

      {status === 'error' && (
        <p className="text-sm text-slate-500 italic">Executive summary unavailable.</p>
      )}

      {(status === 'streaming' || status === 'done') && (
        <p
          className="text-[10px] mt-3 text-slate-600"
          style={{ fontFamily: 'var(--font-geist-mono)' }}
        >
          Generated by Perplexity sonar-pro via Vercel AI Gateway
        </p>
      )}
    </div>
  );
}
