# CybRisk — Enhancements Design

**Date:** 2026-02-28
**Status:** Approved
**Goal:** Five enhancements across board output quality and reach/UX — AI narrative, live FX currency localisation, assessment history, email delivery, and lead capture.

---

## 1. Architecture

All features are additive. No existing routes, components, or data models are changed beyond wiring new components into `results/page.tsx` and adding a narrative paragraph to `docx-report.ts`.

### New files

```
src/app/api/narrative/route.ts          AI executive summary (Anthropic API, streamed)
src/app/api/fx-rates/route.ts           Live FX rates from Yahoo Finance (1h cache)
src/app/api/send-report/route.ts        Email delivery (Resend) + lead capture (Turso)
src/app/history/page.tsx                Assessment history browser
src/components/results/NarrativePanel.tsx   AI summary display (streaming)
src/components/results/CurrencySelector.tsx Currency pill picker
src/components/results/EmailModal.tsx       Email capture modal
src/lib/currency.ts                     Exchange rates, conversion utils
src/lib/turso.ts                        Turso client singleton
```

### Modified files

```
src/app/results/page.tsx        Wire NarrativePanel, CurrencySelector, EmailModal; auto-save to history
src/lib/docx-report.ts          Embed AI narrative between title and first chart
```

### New env vars

```
ANTHROPIC_API_KEY               For narrative generation
RESEND_API_KEY                  For email delivery
TURSO_DATABASE_URL              Turso connection string
TURSO_AUTH_TOKEN                Turso auth token
REPORT_RECIPIENT_EMAIL          BCC copy of every report to Albert
```

### New dependencies

```
@anthropic-ai/sdk               Anthropic API client
resend                          Resend email SDK
@libsql/client                  Turso/libSQL client
```

### Results page layout (after)

```
[Ticker bar + Currency selector]
[AI Narrative panel]                          ← new, full width
[Loss Distribution]  [Exceedance Curve]       ← existing 2-col
[3D Surface]                                  ← existing full-width
[Key Drivers]  [Recommendations]              ← existing 2-col
[Threat Origin Map]  [Industry Tower]         ← existing 2-col
[Regulatory Choropleth]                       ← existing full-width
[Assumptions & Limitations]                   ← existing
[Actions — including Email Report button]     ← existing + new button
```

---

## 2. Feature A — AI Executive Narrative

### Purpose

A 3–4 sentence board-level paragraph contextualising the numbers, written by Claude. The one thing no other risk calculator produces.

### API route — `POST /api/narrative`

Accepts `{ inputs: AssessmentInputs, results: SimulationResults, currency: Currency }`.

Calls Anthropic API with streaming. System prompt:

```
You are a senior cyber risk advisor writing a 3-4 sentence executive summary
for a board audience. Be direct and financial. Cite the ALE figure in the
user's selected currency, name the primary loss driver, and include one
specific regulatory or industry context relevant to their geography and
industry. No jargon. No hedging. No bullet points. No em dashes.
```

Returns a streamed text response. Rate-limited: 10 req/IP/min (reuses existing pattern).

### Component — `NarrativePanel.tsx`

- Calls `POST /api/narrative` on mount after results load
- Shows a skeleton shimmer while streaming
- Displays paragraph in a glassmorphism panel with a 2px left cyan border
- Small "Generated by Claude · Anthropic API" attribution in monospace below
- Re-generates automatically when currency changes

### DOCX integration

Narrative paragraph inserted into `docx-report.ts` between the title block and the first chart section. Formatted as body text (not a heading). If narrative fetch fails, DOCX generation proceeds without it.

---

## 3. Feature B — Currency Localisation

### Purpose

HK/SG/UK boards see results in their own currency. Live rates from Yahoo Finance, hardcoded fallback.

### API route — `GET /api/fx-rates`

Fetches from Yahoo Finance unofficial endpoint:
```
https://query1.finance.yahoo.com/v7/finance/quote?symbols=GBPUSD=X,EURUSD=X,HKDUSD=X,SGDUSD=X
```

- Cached for 1 hour via `revalidate: 3600`
- Falls back to hardcoded rates if Yahoo Finance is unreachable or returns malformed data
- No API key required

### Data — `src/lib/currency.ts`

```typescript
export type Currency = 'USD' | 'GBP' | 'EUR' | 'HKD' | 'SGD';

export const FALLBACK_RATES: Record<Currency, number> = {
  USD: 1.00, GBP: 0.79, EUR: 0.92, HKD: 7.78, SGD: 1.35,
};

export const CURRENCY_SYMBOLS: Record<Currency, string> = {
  USD: '$', GBP: '£', EUR: '€', HKD: 'HK$', SGD: 'S$',
};

export function convertAmount(usd: number, currency: Currency): number { ... }
export function parseYahooFxResponse(json: unknown): Record<Currency, number> { ... }
export function formatCurrency(usd: number, currency: Currency, rates: Record<Currency, number>): string { ... }
```

### Component — `CurrencySelector.tsx`

- Five pill buttons: `USD · GBP · EUR · HKD · SGD`
- Positioned in the ticker bar area (right side)
- Active currency: cyan background
- Fetches `/api/fx-rates` on mount, uses `FALLBACK_RATES` until response arrives
- Persisted in `localStorage` key `cybrisk_currency`

### Conversion scope

All monetary values on the results page: ALE mean, P95, Gordon-Loeb spend, industry benchmark figures (IndustryTower). AI narrative prompt includes selected currency symbol so Claude writes in the right denomination. DOCX export uses active currency at export time.

### Testable logic

- `parseYahooFxResponse()` — unit-tested against a real response fixture and malformed inputs
- `convertAmount()` — unit-tested
- `formatCurrency()` — unit-tested including symbol placement

---

## 4. Feature C — Assessment History

### Purpose

Users can revisit past runs without re-entering inputs. Pure `localStorage` — no backend, no auth.

### Storage schema

Key: `cybrisk_history` → JSON array, newest first, capped at 20 entries.

```typescript
interface HistoryEntry {
  id: string;           // crypto.randomUUID()
  savedAt: string;      // ISO 8601
  label: string;        // auto: "{industry} · {geography} · {date}"
  inputs: AssessmentInputs;
  results: SimulationResults;
  currency: Currency;
}
```

### Save trigger

Auto-saved when results load on `/results`. Deduplication: if an entry with identical inputs exists within the last 24 hours, skip.

### `/history` page

- List of saved assessments, newest first
- Each row: label, ALE mean (in saved currency), date
- Per-row actions: **Load** (writes to `sessionStorage`, navigates to `/results`) and **Delete**
- "Clear all" button
- Empty state with link to `/assess`

### Testable logic (pure utils in `src/lib/history-utils.ts`)

- `saveToHistory()` — deduplication, 20-entry cap
- `loadHistory()` — correct sort order
- `deleteFromHistory()` — removes correct entry

---

## 5. Feature D — Email Delivery + Lead Capture

### Purpose

User receives DOCX report by email. Albert receives a BCC copy. Email + assessment answers stored in Turso as queryable leads.

### Turso schema

```sql
CREATE TABLE leads (
  id          TEXT PRIMARY KEY,
  email       TEXT NOT NULL,
  geography   TEXT NOT NULL,
  industry    TEXT NOT NULL,
  revenue     TEXT NOT NULL,
  answers     TEXT NOT NULL,
  ale_mean    REAL NOT NULL,
  ale_p95     REAL NOT NULL,
  currency    TEXT NOT NULL,
  created_at  TEXT NOT NULL DEFAULT (datetime('now'))
);
```

`answers` stores the full `AssessmentInputs` as a JSON string.

### API route — `POST /api/send-report`

Request body: `{ email: string, inputs: AssessmentInputs, results: SimulationResults, currency: Currency }`

Steps:
1. Zod-validate email
2. Generate DOCX in memory (reuse `generateReport()` from `docx-report.ts`)
3. Send via Resend: `to` = user email, `bcc` = `REPORT_RECIPIENT_EMAIL`, DOCX as attachment
4. Insert row into Turso `leads` table
5. Return `{ ok: true }` or structured error

### Resend email

- From: `CybRisk <reports@cybrisk.vercel.app>`
- Subject: `Your CybRisk Report — {industry} · {geography}`
- Body: plain text with ALE summary + shareable URL link
- Attachment: `CybRisk-Report.docx`

### Component — `EmailModal.tsx`

- Triggered by "Email Report" button in the Actions section
- Single email input + "Send Report" button
- States: idle → sending (disabled, spinner) → success ("Report sent — check your inbox") → error (inline message)
- Auto-closes 2s after success
- Small print: "Your email is used only to deliver this report."

### Querying leads

No admin UI. Query via Turso dashboard or CLI:

```sql
SELECT email, industry, geography, ale_mean, currency, created_at
FROM leads ORDER BY created_at DESC;
```

---

## 6. Testing Strategy

### New unit tests

```
src/__tests__/currency.test.ts          parseYahooFxResponse, convertAmount, formatCurrency (8 tests)
src/__tests__/history-utils.test.ts     saveToHistory, loadHistory, deleteFromHistory (8 tests)
```

### No unit tests for

- `NarrativePanel.tsx` — presentational, tests via TypeScript + build
- `CurrencySelector.tsx` — presentational
- `EmailModal.tsx` — presentational
- `ThreatOriginMap`, `IndustryTower`, `RegulatoryMap` — already verified

### Target test count

180 (current) + 8 (currency) + 8 (history-utils) = **196 tests**

---

## 7. New dependencies

```bash
npm install @anthropic-ai/sdk resend @libsql/client
```

---

## 8. Success Criteria

- AI narrative renders on results page within 3s of load
- Currency selector updates all monetary values immediately
- Selecting a non-USD currency re-triggers narrative generation
- Past assessments persist across browser sessions
- Clicking Load in `/history` restores exact results
- Email sends successfully, DOCX arrives as attachment
- Lead row appears in Turso within 5s of send
- All 196 tests pass
- Production build succeeds
- Vercel preview deployment ready
